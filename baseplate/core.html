<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>baseplate.core &mdash; Baseplate</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.png"/>
    <link rel="top" title="Baseplate" href="../index.html" />
    <link rel="next" title="baseplate.context" href="context/index.html" />
    <link rel="prev" title="baseplate-script" href="../cli/script.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="baseplate-core">
<h1>baseplate.core<a class="headerlink" href="#baseplate-core" title="Permalink to this headline">¶</a></h1>
<p>The heart of the Baseplate framework is its diagnostics system. Here&#8217;s an
incomplete example of an application built on the framework:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">do_something</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request</span><span class="o">.</span><span class="n">some_redis_client</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">make_app</span><span class="p">(</span><span class="n">app_config</span><span class="p">):</span>
    <span class="o">...</span> <span class="n">snip</span> <span class="o">...</span>

    <span class="n">baseplate</span> <span class="o">=</span> <span class="n">Baseplate</span><span class="p">()</span>
    <span class="n">baseplate</span><span class="o">.</span><span class="n">configure_metrics</span><span class="p">(</span><span class="n">metrics_client</span><span class="p">)</span>
    <span class="n">baseplate</span><span class="o">.</span><span class="n">add_to_context</span><span class="p">(</span>
        <span class="s">&quot;some_redis_client&quot;</span><span class="p">,</span> <span class="n">RedisContextFactory</span><span class="p">(</span><span class="n">redis_pool</span><span class="p">))</span>

    <span class="o">...</span> <span class="n">snip</span> <span class="o">...</span>
</pre></div>
</div>
<p>When a request is made which routes to the <tt class="docutils literal"><span class="pre">do_something</span></tt> handler, a
<a class="reference internal" href="#baseplate.core.ServerSpan" title="baseplate.core.ServerSpan"><tt class="xref py py-class docutils literal"><span class="pre">ServerSpan</span></tt></a> is automatically created. If the incoming
request has trace headers, we construct the server span to be identical to the
child span in the upstream service. When we call
<tt class="docutils literal"><span class="pre">request.some_redis_client.ping()</span></tt> in the handler, Baseplate will create a
child <a class="reference internal" href="#baseplate.core.Span" title="baseplate.core.Span"><tt class="xref py py-class docutils literal"><span class="pre">Span</span></tt></a> object to represent the time taken
talking to redis.</p>
<p>The creation of the server and child spans will trigger updates on all the
<a class="reference internal" href="#baseplate.core.ServerSpanObserver" title="baseplate.core.ServerSpanObserver"><tt class="xref py py-class docutils literal"><span class="pre">ServerSpanObserver</span></tt></a> and
<a class="reference internal" href="#baseplate.core.SpanObserver" title="baseplate.core.SpanObserver"><tt class="xref py py-class docutils literal"><span class="pre">SpanObserver</span></tt></a> objects registered.  Because we called
<tt class="docutils literal"><span class="pre">baseplate.configure_metrics</span></tt> in our setup, this means we have observers that
send statsd metrics so Baseplate will automatically send metrics on how long it
took our application to <tt class="docutils literal"><span class="pre">do_something</span></tt> and how long Redis took to respond to
our <tt class="docutils literal"><span class="pre">ping</span></tt> to statsd/Graphite without any extra code in our application.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The documentation below explains how all this works under the hood. If you
just want to write an application, you can skip on to <a class="reference internal" href="integration/index.html"><em>how to integrate
Baseplate with your application framework</em></a> or <a class="reference internal" href="context/index.html"><em>how to
add client libraries to the context object</em></a>.</p>
</div>
<span class="target" id="module-baseplate.core"></span><div class="section" id="baseplate">
<h2>Baseplate<a class="headerlink" href="#baseplate" title="Permalink to this headline">¶</a></h2>
<p>At the root of each application is a single instance of
<a class="reference internal" href="#baseplate.core.Baseplate" title="baseplate.core.Baseplate"><tt class="xref py py-class docutils literal"><span class="pre">Baseplate</span></tt></a>. This object can be integrated with
various other frameworks (e.g. Thrift, Pyramid, etc.) using one of <a class="reference internal" href="integration/index.html"><em>the
integrations</em></a>.</p>
<dl class="class">
<dt id="baseplate.core.Baseplate">
<em class="property">class </em><tt class="descclassname">baseplate.core.</tt><tt class="descname">Baseplate</tt><a class="headerlink" href="#baseplate.core.Baseplate" title="Permalink to this definition">¶</a></dt>
<dd><p>The core of the Baseplate diagnostics framework.</p>
<p>This class coordinates monitoring and tracing of service calls made to
and from this service. See <a class="reference internal" href="integration/index.html#module-baseplate.integration" title="baseplate.integration"><tt class="xref py py-mod docutils literal"><span class="pre">baseplate.integration</span></tt></a> for how to
integrate it with the application framework you are using.</p>
<dl class="method">
<dt id="baseplate.core.Baseplate.register">
<tt class="descname">register</tt><big>(</big><em>observer</em><big>)</big><a class="headerlink" href="#baseplate.core.Baseplate.register" title="Permalink to this definition">¶</a></dt>
<dd><p>Register an observer.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>observer</strong> (<a class="reference internal" href="#baseplate.core.BaseplateObserver" title="baseplate.core.BaseplateObserver"><em>baseplate.core.BaseplateObserver</em></a>) &#8211; An observer.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="baseplate.core.Baseplate.configure_logging">
<tt class="descname">configure_logging</tt><big>(</big><big>)</big><a class="headerlink" href="#baseplate.core.Baseplate.configure_logging" title="Permalink to this definition">¶</a></dt>
<dd><p>Add request context to the logging system.</p>
</dd></dl>

<dl class="method">
<dt id="baseplate.core.Baseplate.configure_metrics">
<tt class="descname">configure_metrics</tt><big>(</big><em>metrics_client</em><big>)</big><a class="headerlink" href="#baseplate.core.Baseplate.configure_metrics" title="Permalink to this definition">¶</a></dt>
<dd><p>Send timing metrics to the given client.</p>
<p>This also adds a <a class="reference internal" href="metrics.html#baseplate.metrics.Batch" title="baseplate.metrics.Batch"><tt class="xref py py-class docutils literal"><span class="pre">baseplate.metrics.Batch</span></tt></a> object to the
<tt class="docutils literal"><span class="pre">metrics</span></tt> attribute on the <a class="reference internal" href="../glossary.html#term-context-object"><em class="xref std std-term">context object</em></a> where you can add
your own application-specific metrics. The batch is automatically
flushed at the end of the request.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>metrics_client</strong> (<a class="reference internal" href="metrics.html#baseplate.metrics.Client" title="baseplate.metrics.Client"><em>baseplate.metrics.Client</em></a>) &#8211; Metrics client to send
request metrics to.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="baseplate.core.Baseplate.configure_tracing">
<tt class="descname">configure_tracing</tt><big>(</big><em>tracing_client</em>, <em>*args</em>, <em>**kwargs</em><big>)</big><a class="headerlink" href="#baseplate.core.Baseplate.configure_tracing" title="Permalink to this definition">¶</a></dt>
<dd><p>Collect and send span information for request tracing.</p>
<p>When configured, this will send tracing information automatically
collected by Baseplate to the configured distributed tracing service.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>tracing_client</strong> (<em>baseplate.diagnostics.tracing.TracingClient</em>) &#8211; Tracing
client to send request traces to.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="baseplate.core.Baseplate.add_to_context">
<tt class="descname">add_to_context</tt><big>(</big><em>name</em>, <em>context_factory</em><big>)</big><a class="headerlink" href="#baseplate.core.Baseplate.add_to_context" title="Permalink to this definition">¶</a></dt>
<dd><p>Add an attribute to each request&#8217;s context object.</p>
<p>On each request, the factory will be asked to create an appropriate
object to attach to the <a class="reference internal" href="../glossary.html#term-context-object"><em class="xref std std-term">context object</em></a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>name</strong> (<a class="reference external" href="https://docs.python.org/3.4/library/stdtypes.html#str" title="(in Python v3.4)"><em>str</em></a>) &#8211; The attribute on the context object to attach the
created object to. This may also be used for metric/tracing
purposes so it should be descriptive.</li>
<li><strong>context_factory</strong> (<a class="reference internal" href="context/index.html#baseplate.context.ContextFactory" title="baseplate.context.ContextFactory"><em>baseplate.context.ContextFactory</em></a>) &#8211; A factory.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="baseplate.core.Baseplate.make_server_span">
<tt class="descname">make_server_span</tt><big>(</big><em>context</em>, <em>name</em>, <em>trace_info=None</em><big>)</big><a class="headerlink" href="#baseplate.core.Baseplate.make_server_span" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a server span representing the request we are handling.</p>
<p>In a server, a server span represents the time spent on a single
incoming request. Any calls made to downstream services will be new
child spans of the server span, and the server span will in turn be the
child span of whatever upstream request it is part of, if any.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>context</strong> &#8211; The <a class="reference internal" href="../glossary.html#term-context-object"><em class="xref std std-term">context object</em></a> for this request.</li>
<li><strong>name</strong> (<a class="reference external" href="https://docs.python.org/3.4/library/stdtypes.html#str" title="(in Python v3.4)"><em>str</em></a>) &#8211; A name to identify the type of this request, e.g.
a route or RPC method name.</li>
<li><strong>trace_info</strong> (<a class="reference internal" href="#baseplate.core.TraceInfo" title="baseplate.core.TraceInfo"><em>baseplate.core.TraceInfo</em></a>) &#8211; The trace context of this
request as passed in from upstream. If <a class="reference external" href="https://docs.python.org/3.4/library/constants.html#None" title="(in Python v3.4)"><tt class="xref py py-data docutils literal"><span class="pre">None</span></tt></a>, a new trace
context will be generated.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="baseplate.core.TraceInfo">
<em class="property">class </em><tt class="descclassname">baseplate.core.</tt><tt class="descname">TraceInfo</tt><a class="headerlink" href="#baseplate.core.TraceInfo" title="Permalink to this definition">¶</a></dt>
<dd><p>Trace context for a span.</p>
<p>If this request was made at the behest of an upstream service, the upstream
service should have passed along trace information. This class is used for
collecting the trace context and passing it along to the server span.</p>
<dl class="classmethod">
<dt id="baseplate.core.TraceInfo.from_upstream">
<em class="property">classmethod </em><tt class="descname">from_upstream</tt><big>(</big><em>trace_id</em>, <em>parent_id</em>, <em>span_id</em>, <em>sampled</em>, <em>flags</em><big>)</big><a class="headerlink" href="#baseplate.core.TraceInfo.from_upstream" title="Permalink to this definition">¶</a></dt>
<dd><p>Build a TraceInfo from individual headers.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>trace_id</strong> (<a class="reference external" href="https://docs.python.org/3.4/library/functions.html#int" title="(in Python v3.4)"><em>int</em></a>) &#8211; The ID of the trace.</li>
<li><strong>parent_id</strong> (<a class="reference external" href="https://docs.python.org/3.4/library/functions.html#int" title="(in Python v3.4)"><em>int</em></a>) &#8211; The ID of the parent span.</li>
<li><strong>span_id</strong> (<a class="reference external" href="https://docs.python.org/3.4/library/functions.html#int" title="(in Python v3.4)"><em>int</em></a>) &#8211; The ID of this span within the tree.</li>
<li><strong>sampled</strong> (<a class="reference external" href="https://docs.python.org/3.4/library/functions.html#bool" title="(in Python v3.4)"><em>bool</em></a>) &#8211; Boolean flag to determine request sampling.</li>
<li><strong>flags</strong> (<a class="reference external" href="https://docs.python.org/3.4/library/functions.html#int" title="(in Python v3.4)"><em>int</em></a>) &#8211; Bit flags for communicating feature flags downstream</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Raises:</th><td class="field-body"><p class="first last"><a class="reference external" href="https://docs.python.org/3.4/library/exceptions.html#ValueError" title="(in Python v3.4)"><tt class="xref py py-exc docutils literal"><span class="pre">ValueError</span></tt></a> if any of the values are inappropriate.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="spans">
<h2>Spans<a class="headerlink" href="#spans" title="Permalink to this headline">¶</a></h2>
<p>Each time a new request comes in to be served, the time taken to handle the
request is represented by a new <a class="reference internal" href="#baseplate.core.ServerSpan" title="baseplate.core.ServerSpan"><tt class="xref py py-class docutils literal"><span class="pre">ServerSpan</span></tt></a> instance.
During the course of handling that request, our application might make calls to
remote services or do expensive calculations, the time spent can be represented
by child <a class="reference internal" href="#baseplate.core.Span" title="baseplate.core.Span"><tt class="xref py py-class docutils literal"><span class="pre">Span</span></tt></a> instances.</p>
<p>Spans have names and IDs and track their parent relationships. When calls are
made to remote services, the information that identifies the local child span
representing that service call is passed along to the remote service and
becomes the server span in the remote service. This allows requests to be traced
across the infrastructure.</p>
<p>Small bits of data, called annotations, can be attached to spans as well. This
could be the URL fetched, or how many items were sent in a batch, or whatever
else might be helpful.</p>
<dl class="class">
<dt id="baseplate.core.ServerSpan">
<em class="property">class </em><tt class="descclassname">baseplate.core.</tt><tt class="descname">ServerSpan</tt><big>(</big><em>trace_id</em>, <em>parent_id</em>, <em>span_id</em>, <em>sampled</em>, <em>flags</em>, <em>name</em>, <em>context</em><big>)</big><a class="headerlink" href="#baseplate.core.ServerSpan" title="Permalink to this definition">¶</a></dt>
<dd><p>A server span represents a request this server is handling.</p>
<p>The server span is available on the <a class="reference internal" href="../glossary.html#term-context-object"><em class="xref std std-term">context object</em></a> during requests
as the <tt class="docutils literal"><span class="pre">trace</span></tt> attribute.</p>
<dl class="method">
<dt id="baseplate.core.ServerSpan.finish">
<tt class="descname">finish</tt><big>(</big><em>exc_info=None</em><big>)</big><a class="headerlink" href="#baseplate.core.ServerSpan.finish" title="Permalink to this definition">¶</a></dt>
<dd><p>Record the end of the span.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>exc_info</strong> &#8211; If the span ended because of an exception, this is
the exception information. The default is <a class="reference external" href="https://docs.python.org/3.4/library/constants.html#None" title="(in Python v3.4)"><tt class="xref py py-data docutils literal"><span class="pre">None</span></tt></a> which
indicates normal exit.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="baseplate.core.ServerSpan.log">
<tt class="descname">log</tt><big>(</big><em>name</em>, <em>payload=None</em><big>)</big><a class="headerlink" href="#baseplate.core.ServerSpan.log" title="Permalink to this definition">¶</a></dt>
<dd><p>Add a log entry to the span.</p>
<p>Log entries are timestamped events recording notable moments in the
lifetime of a span.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>name</strong> (<a class="reference external" href="https://docs.python.org/3.4/library/stdtypes.html#str" title="(in Python v3.4)"><em>str</em></a>) &#8211; The name of the log entry. This should be a stable
identifier that can apply to multiple span instances.</li>
<li><strong>payload</strong> &#8211; Optional log entry payload. This can be arbitrary data.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="baseplate.core.ServerSpan.make_child">
<tt class="descname">make_child</tt><big>(</big><em>name</em>, <em>local=False</em>, <em>component_name=None</em><big>)</big><a class="headerlink" href="#baseplate.core.ServerSpan.make_child" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a child Span whose parent is this Span.</p>
<p>The child span can either be a local span representing an in-request
operation or a span representing an outbound service call.</p>
<p>In a server, a local span represents the time spent within a
local component performing an operation or set of operations.
The local component is some grouping of business logic,
which is then split up into operations which could each be wrapped
in local spans.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>name</strong> (<a class="reference external" href="https://docs.python.org/3.4/library/stdtypes.html#str" title="(in Python v3.4)"><em>str</em></a>) &#8211; Name to identify the operation this span
is recording.</li>
<li><strong>local</strong> (<a class="reference external" href="https://docs.python.org/3.4/library/functions.html#bool" title="(in Python v3.4)"><em>bool</em></a>) &#8211; Make this span a LocalSpan if True, otherwise
make this span a base Span.</li>
<li><strong>component_name</strong> (<a class="reference external" href="https://docs.python.org/3.4/library/stdtypes.html#str" title="(in Python v3.4)"><em>str</em></a>) &#8211; Name to identify local component
this span is recording in if it is a local span.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="baseplate.core.ServerSpan.register">
<tt class="descname">register</tt><big>(</big><em>observer</em><big>)</big><a class="headerlink" href="#baseplate.core.ServerSpan.register" title="Permalink to this definition">¶</a></dt>
<dd><p>Register an observer to receive events from this span.</p>
</dd></dl>

<dl class="method">
<dt id="baseplate.core.ServerSpan.set_tag">
<tt class="descname">set_tag</tt><big>(</big><em>key</em>, <em>value</em><big>)</big><a class="headerlink" href="#baseplate.core.ServerSpan.set_tag" title="Permalink to this definition">¶</a></dt>
<dd><p>Set a tag on the span.</p>
<p>Tags are arbitrary key/value pairs that add context and meaning to the
span, such as a hostname or query string. Observers may interpret or
ignore tags as they desire.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>key</strong> (<a class="reference external" href="https://docs.python.org/3.4/library/stdtypes.html#str" title="(in Python v3.4)"><em>str</em></a>) &#8211; The name of the tag.</li>
<li><strong>value</strong> &#8211; The value of the tag, must be a string/boolean/number.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="baseplate.core.ServerSpan.start">
<tt class="descname">start</tt><big>(</big><big>)</big><a class="headerlink" href="#baseplate.core.ServerSpan.start" title="Permalink to this definition">¶</a></dt>
<dd><p>Record the start of the span.</p>
<p>This notifies any observers that the span has started, which indicates
that timers etc. should start ticking.</p>
<p>Spans also support the <a class="reference external" href="https://docs.python.org/3/reference/datamodel.html#context-managers">context manager protocol</a>, for use with
Python&#8217;s <tt class="docutils literal"><span class="pre">with</span></tt> statement. When the context is entered, the span
calls <a class="reference internal" href="#baseplate.core.ServerSpan.start" title="baseplate.core.ServerSpan.start"><tt class="xref py py-meth docutils literal"><span class="pre">start()</span></tt></a> and when the context is exited it automatically
calls <a class="reference internal" href="#baseplate.core.ServerSpan.finish" title="baseplate.core.ServerSpan.finish"><tt class="xref py py-meth docutils literal"><span class="pre">finish()</span></tt></a>.</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="baseplate.core.Span">
<em class="property">class </em><tt class="descclassname">baseplate.core.</tt><tt class="descname">Span</tt><big>(</big><em>trace_id</em>, <em>parent_id</em>, <em>span_id</em>, <em>sampled</em>, <em>flags</em>, <em>name</em>, <em>context</em><big>)</big><a class="headerlink" href="#baseplate.core.Span" title="Permalink to this definition">¶</a></dt>
<dd><p>A span represents a single RPC within a system.</p>
<dl class="method">
<dt id="baseplate.core.Span.register">
<tt class="descname">register</tt><big>(</big><em>observer</em><big>)</big><a class="headerlink" href="#baseplate.core.Span.register" title="Permalink to this definition">¶</a></dt>
<dd><p>Register an observer to receive events from this span.</p>
</dd></dl>

<dl class="method">
<dt id="baseplate.core.Span.start">
<tt class="descname">start</tt><big>(</big><big>)</big><a class="headerlink" href="#baseplate.core.Span.start" title="Permalink to this definition">¶</a></dt>
<dd><p>Record the start of the span.</p>
<p>This notifies any observers that the span has started, which indicates
that timers etc. should start ticking.</p>
<p>Spans also support the <a class="reference external" href="https://docs.python.org/3/reference/datamodel.html#context-managers">context manager protocol</a>, for use with
Python&#8217;s <tt class="docutils literal"><span class="pre">with</span></tt> statement. When the context is entered, the span
calls <a class="reference internal" href="#baseplate.core.Span.start" title="baseplate.core.Span.start"><tt class="xref py py-meth docutils literal"><span class="pre">start()</span></tt></a> and when the context is exited it automatically
calls <a class="reference internal" href="#baseplate.core.Span.finish" title="baseplate.core.Span.finish"><tt class="xref py py-meth docutils literal"><span class="pre">finish()</span></tt></a>.</p>
</dd></dl>

<dl class="method">
<dt id="baseplate.core.Span.set_tag">
<tt class="descname">set_tag</tt><big>(</big><em>key</em>, <em>value</em><big>)</big><a class="headerlink" href="#baseplate.core.Span.set_tag" title="Permalink to this definition">¶</a></dt>
<dd><p>Set a tag on the span.</p>
<p>Tags are arbitrary key/value pairs that add context and meaning to the
span, such as a hostname or query string. Observers may interpret or
ignore tags as they desire.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>key</strong> (<a class="reference external" href="https://docs.python.org/3.4/library/stdtypes.html#str" title="(in Python v3.4)"><em>str</em></a>) &#8211; The name of the tag.</li>
<li><strong>value</strong> &#8211; The value of the tag, must be a string/boolean/number.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="baseplate.core.Span.log">
<tt class="descname">log</tt><big>(</big><em>name</em>, <em>payload=None</em><big>)</big><a class="headerlink" href="#baseplate.core.Span.log" title="Permalink to this definition">¶</a></dt>
<dd><p>Add a log entry to the span.</p>
<p>Log entries are timestamped events recording notable moments in the
lifetime of a span.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>name</strong> (<a class="reference external" href="https://docs.python.org/3.4/library/stdtypes.html#str" title="(in Python v3.4)"><em>str</em></a>) &#8211; The name of the log entry. This should be a stable
identifier that can apply to multiple span instances.</li>
<li><strong>payload</strong> &#8211; Optional log entry payload. This can be arbitrary data.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="baseplate.core.Span.finish">
<tt class="descname">finish</tt><big>(</big><em>exc_info=None</em><big>)</big><a class="headerlink" href="#baseplate.core.Span.finish" title="Permalink to this definition">¶</a></dt>
<dd><p>Record the end of the span.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>exc_info</strong> &#8211; If the span ended because of an exception, this is
the exception information. The default is <a class="reference external" href="https://docs.python.org/3.4/library/constants.html#None" title="(in Python v3.4)"><tt class="xref py py-data docutils literal"><span class="pre">None</span></tt></a> which
indicates normal exit.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="baseplate.core.Span.make_child">
<tt class="descname">make_child</tt><big>(</big><em>name</em>, <em>local=False</em>, <em>component_name=None</em><big>)</big><a class="headerlink" href="#baseplate.core.Span.make_child" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a child Span whose parent is this Span.</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="observers">
<h2>Observers<a class="headerlink" href="#observers" title="Permalink to this headline">¶</a></h2>
<p>To actually do something with all these spans, Baseplate provides observer
interfaces which receive notification of events happening in the application
via calls to various methods.</p>
<p>The base type of observer is <a class="reference internal" href="#baseplate.core.BaseplateObserver" title="baseplate.core.BaseplateObserver"><tt class="xref py py-class docutils literal"><span class="pre">BaseplateObserver</span></tt></a>
which can be registered with the root <a class="reference internal" href="#baseplate.core.Baseplate" title="baseplate.core.Baseplate"><tt class="xref py py-class docutils literal"><span class="pre">Baseplate</span></tt></a>
instance using the <a class="reference internal" href="#baseplate.core.Baseplate.register" title="baseplate.core.Baseplate.register"><tt class="xref py py-meth docutils literal"><span class="pre">register()</span></tt></a> method.
Whenever a new server span is created in your application (i.e. a new request
comes in to be served) the observer has its
<a class="reference internal" href="#baseplate.core.BaseplateObserver.on_server_span_created" title="baseplate.core.BaseplateObserver.on_server_span_created"><tt class="xref py py-meth docutils literal"><span class="pre">on_server_span_created()</span></tt></a> method
called with the relevant details. This method can register
<a class="reference internal" href="#baseplate.core.ServerSpanObserver" title="baseplate.core.ServerSpanObserver"><tt class="xref py py-class docutils literal"><span class="pre">ServerSpanObserver</span></tt></a> instances with the new server
span to receive events as they happen.</p>
<p>Spans can be notified of four common events:
<a class="reference internal" href="#baseplate.core.SpanObserver.on_start" title="baseplate.core.SpanObserver.on_start"><tt class="xref py py-meth docutils literal"><span class="pre">on_start()</span></tt></a>,
<a class="reference internal" href="#baseplate.core.SpanObserver.on_set_tag" title="baseplate.core.SpanObserver.on_set_tag"><tt class="xref py py-meth docutils literal"><span class="pre">on_set_tag()</span></tt></a>, and
<a class="reference internal" href="#baseplate.core.SpanObserver.on_log" title="baseplate.core.SpanObserver.on_log"><tt class="xref py py-meth docutils literal"><span class="pre">on_log()</span></tt></a>, and
<a class="reference internal" href="#baseplate.core.SpanObserver.on_finish" title="baseplate.core.SpanObserver.on_finish"><tt class="xref py py-meth docutils literal"><span class="pre">on_finish()</span></tt></a>. These represent the span
starting, having tags set, logs entered, and ending, respectively.</p>
<p>Additionally, <a class="reference internal" href="#baseplate.core.ServerSpanObserver" title="baseplate.core.ServerSpanObserver"><tt class="xref py py-class docutils literal"><span class="pre">ServerSpanObserver</span></tt></a> has one extra
event, <a class="reference internal" href="#baseplate.core.ServerSpanObserver.on_child_span_created" title="baseplate.core.ServerSpanObserver.on_child_span_created"><tt class="xref py py-meth docutils literal"><span class="pre">on_child_span_created()</span></tt></a>.
This method is called when a new child span is created in the application for
e.g. a call to a remote service or an expensive computation. This method can
register <a class="reference internal" href="#baseplate.core.SpanObserver" title="baseplate.core.SpanObserver"><tt class="xref py py-class docutils literal"><span class="pre">SpanObserver</span></tt></a> instances with the new child
span to receive events as they happen.</p>
<p>It&#8217;s up to the observers to attach meaning to these events. For example, the
metrics observer would start a timer
<tt class="xref py py-meth docutils literal"><span class="pre">on_start()</span></tt> and record the elapsed time to
statsd <tt class="xref py py-meth docutils literal"><span class="pre">on_finish()</span></tt>.</p>
<dl class="class">
<dt id="baseplate.core.BaseplateObserver">
<em class="property">class </em><tt class="descclassname">baseplate.core.</tt><tt class="descname">BaseplateObserver</tt><a class="headerlink" href="#baseplate.core.BaseplateObserver" title="Permalink to this definition">¶</a></dt>
<dd><p>Interface for an observer that watches Baseplate.</p>
<dl class="method">
<dt id="baseplate.core.BaseplateObserver.on_server_span_created">
<tt class="descname">on_server_span_created</tt><big>(</big><em>context</em>, <em>server_span</em><big>)</big><a class="headerlink" href="#baseplate.core.BaseplateObserver.on_server_span_created" title="Permalink to this definition">¶</a></dt>
<dd><p>Called when a server span is created.</p>
<p><a class="reference internal" href="#baseplate.core.Baseplate" title="baseplate.core.Baseplate"><tt class="xref py py-class docutils literal"><span class="pre">Baseplate</span></tt></a> calls this when a new request begins.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>context</strong> &#8211; The <a class="reference internal" href="../glossary.html#term-context-object"><em class="xref std std-term">context object</em></a> for this request.</li>
<li><strong>server_span</strong> (<a class="reference internal" href="#baseplate.core.ServerSpan" title="baseplate.core.ServerSpan"><em>baseplate.core.ServerSpan</em></a>) &#8211; The span representing
this request.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="baseplate.core.ServerSpanObserver">
<em class="property">class </em><tt class="descclassname">baseplate.core.</tt><tt class="descname">ServerSpanObserver</tt><a class="headerlink" href="#baseplate.core.ServerSpanObserver" title="Permalink to this definition">¶</a></dt>
<dd><p>Interface for an observer that watches the server span.</p>
<dl class="method">
<dt id="baseplate.core.ServerSpanObserver.on_child_span_created">
<tt class="descname">on_child_span_created</tt><big>(</big><em>span</em><big>)</big><a class="headerlink" href="#baseplate.core.ServerSpanObserver.on_child_span_created" title="Permalink to this definition">¶</a></dt>
<dd><p>Called when a child span is created.</p>
<p><a class="reference internal" href="#baseplate.core.SpanObserver" title="baseplate.core.SpanObserver"><tt class="xref py py-class docutils literal"><span class="pre">SpanObserver</span></tt></a> objects call this when a new child span is
created.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>span</strong> (<a class="reference internal" href="#baseplate.core.Span" title="baseplate.core.Span"><em>baseplate.core.Span</em></a>) &#8211; The new child span.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="baseplate.core.ServerSpanObserver.on_finish">
<tt class="descname">on_finish</tt><big>(</big><em>exc_info</em><big>)</big><a class="headerlink" href="#baseplate.core.ServerSpanObserver.on_finish" title="Permalink to this definition">¶</a></dt>
<dd><p>Called when the observed span is finished.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>exc_info</strong> &#8211; If the span ended because of an exception, the
exception info. Otherwise, <a class="reference external" href="https://docs.python.org/3.4/library/constants.html#None" title="(in Python v3.4)"><tt class="xref py py-data docutils literal"><span class="pre">None</span></tt></a>.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="baseplate.core.ServerSpanObserver.on_log">
<tt class="descname">on_log</tt><big>(</big><em>name</em>, <em>payload</em><big>)</big><a class="headerlink" href="#baseplate.core.ServerSpanObserver.on_log" title="Permalink to this definition">¶</a></dt>
<dd><p>Called when a log entry is added to the span.</p>
</dd></dl>

<dl class="method">
<dt id="baseplate.core.ServerSpanObserver.on_set_tag">
<tt class="descname">on_set_tag</tt><big>(</big><em>key</em>, <em>value</em><big>)</big><a class="headerlink" href="#baseplate.core.ServerSpanObserver.on_set_tag" title="Permalink to this definition">¶</a></dt>
<dd><p>Called when a tag is set on the observed span.</p>
</dd></dl>

<dl class="method">
<dt id="baseplate.core.ServerSpanObserver.on_start">
<tt class="descname">on_start</tt><big>(</big><big>)</big><a class="headerlink" href="#baseplate.core.ServerSpanObserver.on_start" title="Permalink to this definition">¶</a></dt>
<dd><p>Called when the observed span is started.</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="baseplate.core.SpanObserver">
<em class="property">class </em><tt class="descclassname">baseplate.core.</tt><tt class="descname">SpanObserver</tt><a class="headerlink" href="#baseplate.core.SpanObserver" title="Permalink to this definition">¶</a></dt>
<dd><p>Interface for an observer that watches a span.</p>
<dl class="method">
<dt id="baseplate.core.SpanObserver.on_start">
<tt class="descname">on_start</tt><big>(</big><big>)</big><a class="headerlink" href="#baseplate.core.SpanObserver.on_start" title="Permalink to this definition">¶</a></dt>
<dd><p>Called when the observed span is started.</p>
</dd></dl>

<dl class="method">
<dt id="baseplate.core.SpanObserver.on_set_tag">
<tt class="descname">on_set_tag</tt><big>(</big><em>key</em>, <em>value</em><big>)</big><a class="headerlink" href="#baseplate.core.SpanObserver.on_set_tag" title="Permalink to this definition">¶</a></dt>
<dd><p>Called when a tag is set on the observed span.</p>
</dd></dl>

<dl class="method">
<dt id="baseplate.core.SpanObserver.on_log">
<tt class="descname">on_log</tt><big>(</big><em>name</em>, <em>payload</em><big>)</big><a class="headerlink" href="#baseplate.core.SpanObserver.on_log" title="Permalink to this definition">¶</a></dt>
<dd><p>Called when a log entry is added to the span.</p>
</dd></dl>

<dl class="method">
<dt id="baseplate.core.SpanObserver.on_finish">
<tt class="descname">on_finish</tt><big>(</big><em>exc_info</em><big>)</big><a class="headerlink" href="#baseplate.core.SpanObserver.on_finish" title="Permalink to this definition">¶</a></dt>
<dd><p>Called when the observed span is finished.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>exc_info</strong> &#8211; If the span ended because of an exception, the
exception info. Otherwise, <a class="reference external" href="https://docs.python.org/3.4/library/constants.html#None" title="(in Python v3.4)"><tt class="xref py py-data docutils literal"><span class="pre">None</span></tt></a>.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="baseplate.core.SpanObserver.on_child_span_created">
<tt class="descname">on_child_span_created</tt><big>(</big><em>span</em><big>)</big><a class="headerlink" href="#baseplate.core.SpanObserver.on_child_span_created" title="Permalink to this definition">¶</a></dt>
<dd><p>Called when a child span is created.</p>
<p><a class="reference internal" href="#baseplate.core.SpanObserver" title="baseplate.core.SpanObserver"><tt class="xref py py-class docutils literal"><span class="pre">SpanObserver</span></tt></a> objects call this when a new child span is
created.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>span</strong> (<a class="reference internal" href="#baseplate.core.Span" title="baseplate.core.Span"><em>baseplate.core.Span</em></a>) &#8211; The new child span.</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="convenience">
<h2>Convenience<a class="headerlink" href="#convenience" title="Permalink to this headline">¶</a></h2>
<p>Baseplate comes with some core monitoring observers built in and just requires
you to configure them. You can enable them by calling the relevant methods on
your application&#8217;s <a class="reference internal" href="#baseplate.core.Baseplate" title="baseplate.core.Baseplate"><tt class="xref py py-class docutils literal"><span class="pre">Baseplate</span></tt></a> object.</p>
<ul class="simple">
<li>Logging: <a class="reference internal" href="#baseplate.core.Baseplate.configure_logging" title="baseplate.core.Baseplate.configure_logging"><tt class="xref py py-meth docutils literal"><span class="pre">configure_logging()</span></tt></a></li>
<li>Metrics (statsd): <a class="reference internal" href="#baseplate.core.Baseplate.configure_metrics" title="baseplate.core.Baseplate.configure_metrics"><tt class="xref py py-meth docutils literal"><span class="pre">configure_metrics()</span></tt></a></li>
<li>Tracing (Zipkin): <a class="reference internal" href="#baseplate.core.Baseplate.configure_tracing" title="baseplate.core.Baseplate.configure_tracing"><tt class="xref py py-meth docutils literal"><span class="pre">configure_tracing()</span></tt></a></li>
</ul>
<p>Additionally, Baseplate provides helpers which can be attached to the
<a class="reference internal" href="../glossary.html#term-context-object"><em class="xref std std-term">context object</em></a> in requests. These helpers make the passing of trace
information and collection of spans automatic and transparent. Because this
pattern is so common, Baseplate has a special kind of observer for it which can
be registered with <a class="reference internal" href="#baseplate.core.Baseplate.add_to_context" title="baseplate.core.Baseplate.add_to_context"><tt class="xref py py-meth docutils literal"><span class="pre">add_to_context()</span></tt></a>. See the
<a class="reference internal" href="context/index.html#module-baseplate.context" title="baseplate.context"><tt class="xref py py-mod docutils literal"><span class="pre">baseplate.context</span></tt></a> package for a list of helpers included.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/baseplate.png" alt="Logo"/>
    
  </a>
</p>






<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quick Start</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cli/healthcheck.html">baseplate-healthcheck: Is your service alive?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli/serve.html">baseplate-serve: The application server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli/script.html">baseplate-script: Run backend scripts</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="">baseplate.core: The guts of the diagnostics framework</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="context/index.html">baseplate.context: Integration with client libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="integration/index.html">baseplate.integration: Integration with application frameworks</a></li>
<li class="toctree-l1"><a class="reference internal" href="diagnostics/index.html">baseplate.diagnostics: Diagnostics observers</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html">baseplate: General purpose helpers</a></li>
<li class="toctree-l1"><a class="reference internal" href="config.html">baseplate.config: Configuration parsing</a></li>
<li class="toctree-l1"><a class="reference internal" href="crypto.html">baseplate.crypto: Cryptographic Primitives</a></li>
<li class="toctree-l1"><a class="reference internal" href="events.html">baseplate.events: Events for the data pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="message_queue.html">baseplate.message_queue: POSIX IPC Message Queues</a></li>
<li class="toctree-l1"><a class="reference internal" href="metrics.html">baseplate.metrics: Counters and timers for statsd</a></li>
<li class="toctree-l1"><a class="reference internal" href="random.html">baseplate.random: Extensions to the standard library&#8217;s random module</a></li>
<li class="toctree-l1"><a class="reference internal" href="retry.html">baseplate.retry: Policies for retrying operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="thrift_pool.html">baseplate.thrift_pool: A Thrift client connection pool</a></li>
<li class="toctree-l1"><a class="reference internal" href="service_discovery.html">baseplate.service_discovery: Integration with Synapse service discovery</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="../cli/script.html" title="previous chapter">baseplate-script</a></li>
      <li>Next: <a href="context/index.html" title="next chapter">baseplate.context</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      
      
      
      <a href="../_sources/baseplate/core.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>